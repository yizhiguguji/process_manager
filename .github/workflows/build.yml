  # .github/workflows/build.yml

  name: Create and Upload Release

  on:
    push:
      tags:
        - 'v*' # 监听所有以 "v" 开头的标签

  permissions:
    contents: write

  jobs:
    # --- 第一阶段：构建 ---
    build-macos:
      name: Build macOS Universal
      runs-on: macos-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Flutter
          uses: subosito/flutter-action@v2
          with:
            channel: 'stable'

        - name: Get dependencies
          run: flutter pub get

        - name: Build macOS Universal Binary
          run: flutter build macos

        - name: Package macOS app
          run: zip -r process-manager-macos-universal.zip process_manager.app
          working-directory: build/macos/Build/Products/Release

        - name: Upload macOS Artifact
          uses: actions/upload-artifact@v4
          with:
            name: macos-build
            path: build/macos/Build/Products/Release/process-manager-macos-universal.zip

    build-windows:
      name: Build Windows
      runs-on: windows-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Flutter
          uses: subosito/flutter-action@v2
          with:
            channel: 'stable'

        - name: Force recreate Windows platform files
          shell: pwsh
          run: |
            if (Test-Path windows) {
              Remove-Item -Recurse -Force windows
            }
            flutter create --platforms=windows .
            flutter pub get

        - name: Build Windows app
          run: flutter build windows

        - name: Package Windows app
          shell: pwsh
          run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath build/windows/x64/runner/process-manager-windows.zip

        - name: Upload Windows Artifact
          uses: actions/upload-artifact@v4
          with:
            name: windows-build
            path: build/windows/x64/runner/process-manager-windows.zip

    # --- 第二阶段：发布，保持不变 ---
    release:
      name: Create GitHub Release
      runs-on: ubuntu-latest
      needs: [build-macos, build-windows]
      steps:
        - name: Create GitHub Release
          id: create_release
          uses: softprops/action-gh-release@v2
          with:
            name: Release ${{ github.ref_name }}
            tag_name: ${{ github.ref_name }}
            generate_release_notes: true

        - name: Download all artifacts
          uses: actions/download-artifact@v4
          with:
            path: artifacts

        - name: Upload assets to release
          uses: softprops/action-gh-release@v2
          with:
            files: artifacts/*/*.zip
